#!/usr/bin/env bash
# BrainCraft.io DevContainer Entrypoint Script
set -euo pipefail

# Display BrainCraft.io banner
cat << 'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘       ðŸ§  BrainCraft.io Development Environment ðŸ§         â•‘
â•‘                                                          â•‘
â•‘         Practitioner first AI Codegen Framework          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF

echo ""
echo "ðŸš€ Starting BrainCraft.io DevContainer..."
echo ""

# Ensure workspace permissions are correct
if [[ -d "/workspace" ]]; then
    echo "ðŸ“ Ensuring correct workspace permissions..."
    sudo chown -R ubuntu:ubuntu /workspace 2>/dev/null || true
fi

# Check mise installation
if command -v mise &>/dev/null; then
    echo "âœ… mise is available: $(mise --version)"
    
    # Trust mise configuration if present
    if [[ -f "/workspace/.mise.toml" ]]; then
        echo "ðŸ“¦ Trusting mise configuration..."
        cd /workspace && mise trust --yes
        echo "ðŸ“¦ Installing tools defined in .mise.toml..."
        mise install || true
    fi
else
    echo "âš ï¸  mise not found - tools will need manual installation"
fi

# Setup direnv if available
if command -v direnv &>/dev/null; then
    echo "âœ… direnv is available"
    if [[ -f "/workspace/.envrc" ]]; then
        echo "ðŸ” Allowing direnv for workspace..."
        direnv allow /workspace
    fi
fi

# Configure git
if command -v git &>/dev/null; then
    echo "ðŸ“ Configuring git..."
    git config --global --add safe.directory '*'
    git config --global init.defaultBranch main
    git config --global pull.rebase false
fi

# Setup GitHub CLI if authenticated
if command -v gh &>/dev/null; then
    if gh auth status &>/dev/null; then
        echo "âœ… GitHub CLI authenticated"
        gh auth setup-git || true
    else
        echo "â„¹ï¸  GitHub CLI not authenticated - run 'gh auth login' to authenticate"
    fi
fi

# Show available tools
echo ""
echo "ðŸ› ï¸  Available tools:"
echo "  - Go:     $(go version 2>/dev/null || echo 'not installed')"
echo "  - Node:   $(node --version 2>/dev/null || echo 'not installed')"
echo "  - Python: $(python3 --version 2>/dev/null || echo 'not installed')"
echo "  - Rust:   $(rustc --version 2>/dev/null || echo 'not installed')"
echo "  - Docker: $(docker --version 2>/dev/null || echo 'not installed')"
echo "  - kubectl: $(kubectl version --client --short 2>/dev/null || echo 'not installed')"
echo "  - Helm:   $(helm version --short 2>/dev/null || echo 'not installed')"

# Show mise tasks if available
if command -v mise &>/dev/null && [[ -f "/workspace/.mise.toml" ]]; then
    echo ""
    echo "ðŸ“‹ Available mise tasks:"
    mise tasks --no-header 2>/dev/null | head -10 || true
    echo "   ... run 'mise tasks' to see all tasks"
fi

echo ""
echo "âœ¨ DevContainer ready!"
echo "ðŸ’¡ Run 'mise tasks' to see available commands"
echo ""

# Execute the command passed to the container (or bash if none)
if [ $# -eq 0 ]; then
    exec /bin/bash -l
else
    exec "$@"
fi